<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Usuarios (JSON persistente)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{margin:0;min-height:100dvh;display:grid;place-items:center;background:#0f1115;color:#e6e6e6;font-family:system-ui,Segoe UI,Roboto,Arial}
    .card{width:min(700px,92vw);background:#151923;border:1px solid #222838;border-radius:16px;box-shadow:0 6px 30px rgba(0,0,0,.35);padding:20px}
    h1{margin:.2rem 0 1rem;font-size:1.2rem}
    form{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    label{font-size:.85rem;color:#a8b0c0}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid #222838;background:#0f1320;color:#e6e6e6}
    button{cursor:pointer;background:linear-gradient(180deg,#0f3b55,#0b2a3c);border-color:#10344a}
    table{width:100%;border-collapse:collapse;margin-top:16px;font-size:.92rem}
    th,td{border-bottom:1px solid #222838;padding:10px 8px;text-align:left}
    .tag{font-size:.75rem;padding:4px 8px;border-radius:999px;background:#0f2a33;color:#8cd3ff;border:1px solid #10344a}
    .row-span{grid-column:1 / -1}
    .msg.ok{color:#baf7c0}.msg.err{color:#ffc4c4}
  </style>
</head>
<body>
  <div class="card">
    <h1>Alta de usuarios (persistencia en archivo JSON)</h1>
    <form id="form">
      <div>
        <label>Usuario</label>
        <input id="usuario" required autocomplete="off"/>
      </div>
      <div>
        <label>Contraseña</label>
        <input id="password" type="password" required/>
      </div>
      <div>
        <label>Sede</label>
        <select id="sede">
          <option value="olavarria">Olavarría</option>
          <option value="cordoba" selected>Córdoba</option>
        </select>
      </div>
      <div class="row-span">
        <button type="submit">Crear</button>
      </div>
      <div id="msg" class="row-span msg" aria-live="polite"></div>
    </form>

    <table id="tabla">
      <thead><tr><th>ID</th><th>Usuario</th><th>Sede</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const tbody = $('#tabla tbody');
    const msg = $('#msg');

    function setMsg(t, ok=true){ msg.textContent=t; msg.className = 'row-span msg ' + (ok?'ok':'err'); }

    function render(users){
      tbody.innerHTML = '';
      if(!users.length){
        tbody.innerHTML = '<tr><td colspan="3" style="color:#a8b0c0">Sin usuarios aún</td></tr>';
        return;
      }
      for(const u of users){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.id}</td>
          <td>${escapeHTML(u.usuario)}</td>
          <td><span class="tag">${u.sede}</span></td>
        `;
        tbody.appendChild(tr);
      }
    }
    function escapeHTML(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;"); }

    async function fetchUsers(){
      const r = await fetch('/api/users'); const j = await r.json(); render(j);
    }

    $('#form').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const usuario = $('#usuario').value.trim();
      const password = $('#password').value;
      const sede = $('#sede').value;
      if(!usuario || !password){ setMsg('Completá usuario y contraseña', false); return; }

      const r = await fetch('/api/users', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ usuario, password, sede })
      });
      const j = await r.json();
      if(!r.ok){ setMsg(j.error || 'No se pudo crear', false); return; }
      setMsg('Usuario creado ✔');
      $('#usuario').value=''; $('#password').value='';
      fetchUsers();
    });

    fetchUsers();
  </script>
</body>
</html>
